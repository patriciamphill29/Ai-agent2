name: Run Tests with tmate

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  run-test-command:
    runs-on: ubuntu-latest

    steps:
    - name: Maximize Build Space
      uses: easimon/maximize-build-space@master
      with:
        root-reserve-mb: 2048
        swap-size-mb: 512
        remove-dotnet: 'true'
        remove-android: 'true'
        remove-haskell: 'true'
        remove-codeql: 'true'
        remove-docker-images: 'false'

    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Verify Free Space
      run: |
        echo "Disk Space:"
        df -h
        echo "----------------"
        echo "Memory/Swap:"
        free -m

    - name: Create Directories
      run: |
        BASE=/home/runner/work/Ai-agent2/Ai-agent2
        mkdir -p $BASE/config
        mkdir -p $BASE/downloads
        chmod -R 777 $BASE

    # ðŸ”¥ IMPORTANT FIX: wipe qbittorrent config so env vars apply
    - name: Reset qBittorrent Config
      run: |
        rm -rf /home/runner/work/Ai-agent2/Ai-agent2/config/*

    - name: Install Cloudflared
      run: |
        sudo mkdir -p --mode=0755 /usr/share/keyrings
        curl -fsSL https://pkg.cloudflare.com/cloudflare-public-v2.gpg \
          | sudo tee /usr/share/keyrings/cloudflare-public-v2.gpg >/dev/null

        echo 'deb [signed-by=/usr/share/keyrings/cloudflare-public-v2.gpg] https://pkg.cloudflare.com/cloudflared any main' \
          | sudo tee /etc/apt/sources.list.d/cloudflared.list

        sudo apt-get update
        sudo apt-get install -y cloudflared

        # Installs the service using your token secret
        sudo cloudflared service install ${{ secrets.CLOUDFLARE_TOKEN }}

    # -----------------------------------------------------------
    # 1. RUN PORTAINER (Docker Management UI) - Port 9000
    # -----------------------------------------------------------
    - name: Run Portainer
      run: |
        docker run -d \
          -p 9000:9000 \
          --name=portainer \
          --restart=always \
          -v /var/run/docker.sock:/var/run/docker.sock \
          -v portainer_data:/data \
          portainer/portainer-ce:latest

    # -----------------------------------------------------------
    # 2. RUN TTYD (Web Terminal) - Port 7681
    # -----------------------------------------------------------
    - name: Run Ttyd (Web Terminal)
      run: |
        docker run -d \
          --name ttyd \
          -p 7681:7681 \
          -v /home/runner/work/Ai-agent2/Ai-agent2:/workspace \
          --workdir /workspace \
          tsl0922/ttyd:alpine \
          ttyd -W -c admin:password123 bash

    - name: Run qBittorrent
      run: |
        docker run -d \
          --name=qbittorrent \
          -e PUID=1000 \
          -e PGID=1000 \
          -e WEBUI_PORT=8081 \
          -e WEBUI_USERNAME=mahdi \
          -e WEBUI_PASSWORD=mahdi2019 \
          -p 8081:8081 \
          -p 6881:6881 \
          -p 6881:6881/udp \
          -v /home/runner/work/Ai-agent2/Ai-agent2/config:/config \
          -v /home/runner/work/Ai-agent2/Ai-agent2/downloads:/downloads \
          --restart unless-stopped \
          linuxserver/qbittorrent:latest

    - name: Run FileGator
      run: |
        docker run -d \
          --name=filegator \
          -p 8080:8080 \
          -v /home/runner/work/Ai-agent2/Ai-agent2:/var/www/filegator/repository \
          -e FILEGATOR_USERNAME=mahdi \
          -e FILEGATOR_PASSWORD=mahdi2019 \
          --restart unless-stopped \
          filegator/filegator

    # Keep the job alive so Cloudflare tunnel stays up
    - name: Keep Alive
      run: sleep 6h
