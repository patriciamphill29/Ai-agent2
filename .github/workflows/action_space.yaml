name: Run Tests with tmate

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  run-test-command:
    runs-on: ubuntu-latest
    steps:
     - name: Maximize Build Space
       uses: easimon/maximize-build-space@master
       with:
        root-reserve-mb: 2048       # Keep 2GB for system
        swap-size-mb: 512          # Shrink swap to 1GB (default is 4GB)
        remove-dotnet: 'true'       # Remove .NET
        remove-android: 'true'      # Remove Android SDKs
        remove-haskell: 'true'      # Remove Haskell
        remove-codeql: 'true'       # Remove CodeQL
        remove-docker-images: 'false' # Remove cached Docker images
      
     - name: Checkout Code
       uses: actions/checkout@v4
    
     - name: Verify Free Space
       run: |
        echo "Disk Space:"
        df -h
        echo "----------------"
        echo "Memory/Swap:"
        free -m


     - name: Create Directories
       run: |
          mkdir -p /home/runner/work/Ai-agent2/Ai-agent2/config
          mkdir -p /home/runner/work/Ai-agent2/Ai-agent2/downloads
          chmod -R 777 /home/runner/work/Ai-agent2/Ai-agent2

     - name: Install Cloudflared
       run: |
          # Add cloudflare gpg key
          sudo mkdir -p --mode=0755 /usr/share/keyrings
          curl -fsSL https://pkg.cloudflare.com/cloudflare-public-v2.gpg | sudo tee /usr/share/keyrings/cloudflare-public-v2.gpg >/dev/null

          # Add this repo to your apt repositories
          echo 'deb [signed-by=/usr/share/keyrings/cloudflare-public-v2.gpg] https://pkg.cloudflare.com/cloudflared any main' | sudo tee /etc/apt/sources.list.d/cloudflared.list

          # install cloudflared
          sudo apt-get update && sudo apt-get install cloudflared

          # install service
          sudo cloudflared service install ${{ secrets.CLOUDFLARE_TOKEN }}

     - name: Install qBittorrent
       run: |
          docker run -d \
            --name=qbittorrent \
            -e PUID=1001 \
            -e PGID=1001 \
            -e WEBUI_PORT=8081 \
            -e WEBUI_USERNAME=mahdi \
            -e WEBUI_PASSWORD=mahdi2019 \
            -p 8081:8081 \
            -p 6881:6881 \
            -p 6881:6881/udp \
            -v /home/runner/work/Ai-agent2/Ai-agent2/config:/config \
            -v /home/runner/work/Ai-agent2/Ai-agent2/downloads:/downloads \
            --restart unless-stopped \
            linuxserver/qbittorrent:latest

     - name: Install FileBrowser
       run: |
          # 1. Create the directory
          mkdir -p /home/runner/work/Ai-agent2/Ai-agent2/filebrowser
          
          # 2. CRITICAL: Create the empty DB file explicitly
          touch /home/runner/work/Ai-agent2/Ai-agent2/filebrowser/database.db
          
          # 3. Create a placeholder settings file (optional but safe)
          touch /home/runner/work/Ai-agent2/Ai-agent2/filebrowser/filebrowser.json

          # 4. Start the container
          docker run -d \
            --name=filebrowser \
            -p 8080:80 \
            -v /home/runner/work/Ai-agent2/Ai-agent2:/srv \
            -v /home/runner/work/Ai-agent2/Ai-agent2/filebrowser/database.db:/database.db \
            -v /home/runner/work/Ai-agent2/Ai-agent2/filebrowser/filebrowser.json:/.filebrowser.json \
            -e PUID=1001 \
            -e PGID=1001 \
            --restart unless-stopped \
            filebrowser/filebrowser:latest
          
          # 5. Wait for startup
          sleep 5
          
          # 6. Set credentials
          # Note: We must specify the DB path inside the exec command just in case
          docker exec filebrowser filebrowser users add mahdi mahdi2019 --perm.admin
     - name: Start SSH Session
       uses: mxschmitt/action-tmate@v3
